# RoomDetectionService

**Location**: `src/services/RoomDetectionService/RoomDetectionService.ts`
**Dependencies**: None
**Test Coverage**: Floodfill, boundary detection, room reveal

---

## Purpose

Detects connected room tiles via 4-directional floodfill. Used by FOVService in room-reveal mode to reveal entire rooms upon entry.

---

## Public API

### detectRoom(position: Position, level: Level): Set<string>

Floodfills from position to find all connected room tiles. Returns Set of position keys ("x,y") including room tiles and boundaries (walls/doors).

**Parameters**:
- `position` - Starting position (typically player position)
- `level` - Current dungeon level

**Returns**: `Set<string>` - Position keys in "x,y" format

**Algorithm**: 4-directional floodfill + boundary detection

**Behavior**:
1. **Check Starting Position**:
   - If position is a room tile (`isRoom: true`): Start floodfill
   - If position is not a room (corridor/door): Check adjacent tiles for room
   - If adjacent room found: Start floodfill from that tile
   - If no room nearby: Return empty set

2. **Floodfill Room Tiles** (4-directional):
   - Start from initial position
   - Add to queue and visited set
   - For each queued position:
     - Check 4 directions (N, E, S, W)
     - If neighbor is room tile and not visited: Add to queue
     - Stop at walls, doors, corridors (`isRoom: false`)

3. **Add Boundary Tiles** (8-directional):
   - For each room tile found:
     - Check all 8 surrounding positions
     - If neighbor is wall or door (not corridor): Add to boundary
     - Result: Room tiles + surrounding walls/doors

**Example**:
```typescript
const roomDetection = new RoomDetectionService()

// Player enters room at (10, 5)
const roomTiles = roomDetection.detectRoom(
  { x: 10, y: 5 },
  currentLevel
)

// Returns Set: ["10,5", "10,6", "11,5", "11,6", ...walls/doors...]
// All connected room floor tiles + boundary walls/doors
```

---

## Integration Notes

### FOV Room-Reveal Mode

**Usage Pattern**:
```typescript
// In FOVService (room-reveal mode)
if (fovMode === 'room-reveal') {
  // Player entered new room
  const roomTiles = roomDetectionService.detectRoom(
    player.position,
    level
  )

  // Reveal entire room at once
  for (const tileKey of roomTiles) {
    exploredCells.add(tileKey)
  }
}
```

**Why Room Detection?**
- **Room-Reveal Mode**: Entire room revealed when player enters (classic Rogue)
- **Radius Mode**: Only tiles within light radius revealed (modern roguelike)

### Doorway Handling

**Special Case**: Player standing in doorway
```typescript
// Player at door position (not a room tile)
const roomTiles = roomDetectionService.detectRoom(doorPosition, level)

// Algorithm checks adjacent tiles:
// - Finds room tile next to door
// - Starts floodfill from that room tile
// - Returns all connected room tiles + boundaries
```

**Result**: Opening door reveals the room beyond

---

## Testing

**Test Files**:
- `RoomDetectionService.test.ts` - Floodfill algorithm, boundary detection

**Coverage**: Comprehensive (4-directional floodfill, boundary walls, doorway edge cases)

---

## Technical Details

### Algorithm Visualization

**Room Structure**:
```
###########    # = Wall (boundary)
#.........#    . = Room floor (isRoom: true)
#.........#    + = Door (boundary)
#....@....#    @ = Player position
#.........#
#.........#
#####+#####
```

**Floodfill Result**:
- **Room tiles**: All `.` tiles (connected floor)
- **Boundary tiles**: All `#` walls and `+` doors surrounding room
- **Returned Set**: `{"5,1", "6,1", ..., "0,0", "10,0", "5,6", ...}`

### 4-Directional vs 8-Directional

**Floodfill**: 4-directional (N, E, S, W only)
```typescript
const directions = [
  { x: 0, y: -1 }, // North
  { x: 1, y: 0 },  // East
  { x: 0, y: 1 },  // South
  { x: -1, y: 0 }  // West
]
```

**Why not 8-directional?**
- Prevents diagonal "leaking" between rooms
- Matches dungeon generation algorithm (rooms connected by corridors, not diagonals)

**Boundary Detection**: 8-directional (includes diagonals)
```typescript
const directions = [
  { x: 0, y: -1 },  // N
  { x: 1, y: -1 },  // NE
  { x: 1, y: 0 },   // E
  { x: 1, y: 1 },   // SE
  { x: 0, y: 1 },   // S
  { x: -1, y: 1 },  // SW
  { x: -1, y: 0 },  // W
  { x: -1, y: -1 }  // NW
]
```

**Why 8-directional for boundaries?**
- Captures corner walls
- Ensures complete room outline visible

### Room vs Corridor Distinction

**Room Tiles** (`tile.isRoom === true`):
- Open floor spaces inside rectangular rooms
- Generated by RoomGenerationService
- Connected within room boundaries

**Corridor Tiles** (`tile.isRoom === false`):
- Walkable passages between rooms
- Generated by CorridorGenerationService
- NOT included in room detection

**Why Distinction Matters**:
```
Room A    Corridor    Room B
######    .........   ######
#....#    .........   #....#
#....+...........+....#....#
#....#    .........   #....#
######    .........   ######
```

**Floodfill from Room A stops at door** (corridor has `isRoom: false`)

Result: Only Room A revealed, not corridor or Room B

---

## Performance

**Time Complexity**: O(R) where R = number of room tiles
- Each tile visited at most once
- Queue operations: O(1) per tile
- Set operations: O(1) average case

**Space Complexity**: O(R)
- Queue size: O(R) worst case
- Visited set: O(R)

**Typical Performance**:
- Small room (5×5): ~25 tiles checked, <1ms
- Large room (15×15): ~225 tiles checked, <5ms
- Negligible impact on FOV calculation

---

## Related Services

- [FOVService](./FOVService.md) - Uses for room-reveal mode
- [RoomGenerationService](./RoomGenerationService.md) - Generates rooms with `isRoom: true` flag
- [CorridorGenerationService](./CorridorGenerationService.md) - Generates corridors with `isRoom: false` flag
